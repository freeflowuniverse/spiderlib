# ThreeFold Connect

Module to use ThreeFold Connect Authentication in V projects.

## Creating keys

The Authenticator uses a keypair to sign and decrypt reuests made to TFConnect API. This ensures the authenticator that the response sent to the callback route is a valid, authentic response to the redirect url generated by the authenticator. The keys are automatically generated when a new authenticator is created if a keypair is not provided.

`keypair := config.keypair or { create_keypair() }`

The keys can also be created beforehand, written into a keys.toml file, and used when creating a new authenticator the following way.

```
write_keys()
keypair := load_keys()
authenticator := tfconnect.new(
    keypair := keypair
)
```

## Creating authenticator

The Authenticator struct holds a keypair to sign and decrypt reuests made to TFConnect API. This ensures the authenticator that the response sent to the callback route is a valid, authentic response to the redirect url generated by the authenticator.

```
authenticator := tfconnect.new(
    app_id: 'localhost:8080'
    callback: '/callback'
    scopes: tfconnect.Scopes{
        email: true
    }
)!
```

## Creating TFConnect login url

Can be done with: `url := authenticator.create_login_url()`
The create login url will be created for the scope and callback url passed when creating the authenticator.

## Decoding callback

The TFConnect response to the authentication attempt is passed as a query to the callback url. The signed attempt can be decoded the following way
```
query := app.query.clone()
signed_attempt := tfconnect.load_signed_attempt(query) or {
    app.error('Could not load signed tfconnect login attempt')
    return app.server_error(400)
}
```
Once decoded, the signed attempt can be verified, and the requested scopes are returned as a json string.
```
res := app.authenticator.verify(signed_attempt) or {
    app.error('Could not verify signed tfconnect login attempt')
    return app.server_error(400)
}
```

## Controller

The module includes a vweb controller for easily adding TFConnect authentication routes to the application. See [vweb docs]() on how to use and add controllers to vweb applications.

## Example

To run the TFConnect example vweb application, `v run examples/tfconnect`